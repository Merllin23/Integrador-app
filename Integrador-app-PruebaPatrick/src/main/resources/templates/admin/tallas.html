<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tallas - JKM Confecciones</title>

    <th:block th:fragment="extraCss">
        <style>
            /* RESET */
            * { box-sizing: border-box; margin:0; padding:0; }
            body { font-family: 'Poppins', sans-serif; background:#f9fafb; color:#111827; }

            /* CONTENEDOR PRINCIPAL */
            .container { max-width:1200px; margin:0 auto; padding:2rem; }

            /* CABECERA */
            h1 { font-size:2.25rem; font-weight:700; margin-bottom:0.25rem; }
            p.subtitle { color:#6b7280; font-size:0.95rem; margin-bottom:1.5rem; }

            /* FILTROS */
            .filtros { display:flex; gap:0.75rem; flex-wrap:wrap; margin-bottom:1.5rem; }
            .filtros input {
                padding:0.5rem 0.75rem;
                border-radius:0.5rem;
                border:1px solid #d1d5db;
                background:white;
                outline:none;
                transition:all 0.2s;
            }
            .filtros input:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,0.15); }

            /* TABLA */
            .tabla-container { background:white; border-radius:1rem; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
            .tabla-wrapper { overflow-x:auto; }
            table { width:100%; border-collapse:collapse; }
            thead { background:#f3f4f6; }
            th { padding:1rem; text-align:left; font-weight:600; color:#111827; border-bottom:2px solid #e5e7eb; }
            td { padding:1rem; border-bottom:1px solid #e5e7eb; }
            tbody tr:hover { background:#f9fafb; }
            .img-thumbnail { width:50px; height:50px; object-fit:cover; border-radius:0.5rem; background:#f3f4f6; }

            /* BOTONES */
            .btn { padding:0.4rem 0.8rem; border-radius:0.5rem; font-weight:500; border:none; cursor:pointer; transition:all 0.2s; }
            .btn-activar { background:#22c55e; color:white; }
            .btn-activar:hover { background:#16a34a; }
            .btn-desactivar { background:#ef4444; color:white; }
            .btn-desactivar:hover { background:#dc2626; }
            .btn-buscar { background:#2563eb; color:white; }
            .btn-buscar:hover { background:#1d4ed8; }

            /* ESTADO */
            .estado-activo { color:#22c55e; font-weight:600; }
            .estado-inactivo { color:#ef4444; font-weight:600; }

            /* MODALES */
            .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:50; }
            .modal.active { display:flex; }
            .modal-content { background:white; border-radius:1rem; padding:2rem; max-width:500px; box-shadow:0 10px 25px rgba(0,0,0,0.15); }
            .modal-content h2 { font-size:1.25rem; font-weight:600; margin-bottom:1rem; }
            .modal-content p { margin-bottom:1rem; color:#6b7280; }
            .modal-actions { display:flex; gap:1rem; justify-content:flex-end; }
            .modal-actions button { padding:0.5rem 1rem; border-radius:0.5rem; border:none; cursor:pointer; font-weight:500; }
            .btn-cancel { background:#e5e7eb; color:#111827; }
            .btn-cancel:hover { background:#d1d5db; }
            .btn-confirm { background:#2563eb; color:white; }
            .btn-confirm:hover { background:#1d4ed8; }

            /* NOTIFICACIONES */
            .notificacion { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:0.5rem; color:white; font-weight:500; z-index:100; }
            .notificacion.success { background:#22c55e; }
            .notificacion.error { background:#ef4444; }

            /* RESPONSIVE */
            @media(max-width:768px) {
                table { font-size:0.9rem; }
                th, td { padding:0.75rem; }
                .btn { padding:0.3rem 0.6rem; font-size:0.9rem; }
            }
        </style>
    </th:block>
</head>

<body>
<th:block th:fragment="mainContent">
    <div class="container">
        <h1 class="text-3xl font-semibold text-jk-blue">Gestión de Tallas de Productos</h1>
        <p class="subtitle">Administra las tallas disponibles y su estado activo/inactivo</p>

        <!-- CONTROLES Y BÚSQUEDA -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="filtros">
                <input type="text" id="searchInput" placeholder="Buscar producto o talla..." 
                       class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-80">
            </div>
            <div class="flex gap-2">
                <button onclick="aplicarFiltro()" class="btn btn-buscar">
                    <i class="fas fa-search mr-2"></i> Buscar
                </button>
                <button onclick="recargar()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-redo mr-2"></i> Recargar
                </button>
            </div>
        </div>

        <!-- TABLA DE TALLAS -->
        <div class="tabla-container">
            <div class="tabla-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:80px;">Imagen</th>
                            <th>Producto</th>
                            <th>Talla</th>
                            <th style="text-align:center;">Stock</th>
                            <th style="text-align:center;">Precio Unitario</th>
                            <th style="text-align:center;">Estado</th>
                            <th style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaTallas">
                        <tr>
                            <td colspan="6" style="text-align:center; padding:2rem; color:#999;">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Cargando tallas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mensaje si no hay datos -->
            <div id="noDataMessage" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-inbox mr-2"></i> No hay tallas disponibles
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación (moved inside fragment so layout includes it) -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmar cambio de estado</h2>
            <p>¿Estás seguro de que deseas cambiar el estado de esta talla?</p>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="btn btn-confirm" onclick="confirmarCambio()">Confirmar</button>
            </div>
        </div>
    </div>
</th:block>

<!-- JavaScript Fragment -->
<th:block th:fragment="extraJs">
    <script>
        let allData = [];
        let dataAConfirmar = null;

        document.addEventListener('DOMContentLoaded', cargarTallas);
        // Llamada inmediata por si el script se inserta después de DOMContentLoaded
        cargarTallas();

        async function cargarTallas() {
            try {
                const response = await fetch('/admin/tallas/api/list');
                allData = await response.json();
                mostrarTabla(allData);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('noDataMessage').classList.remove('hidden');
            }
        }

        function mostrarTabla(datos) {
            const tabla = document.getElementById('tablaTallas');
            const noData = document.getElementById('noDataMessage');

            if (datos.length === 0) {
                tabla.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            tabla.innerHTML = datos.map(item => `
                <tr>
                    <td style="text-align:center; padding:0.5rem;">
                        ${item.productoimagenUrl ? 
                            `<img src="${item.productoimagenUrl}" alt="${item.productoNombre}" class="img-thumbnail">` :
                            `<div style="width:50px; height:50px; border-radius:0.5rem; background:#f3f4f6; display:flex; align-items:center; justify-content:center; margin:0 auto;"><i class="fas fa-image" style="color:#9ca3af;"></i></div>`
                        }
                    </td>
                    <td>${item.productoNombre}</td>
                    <td>${item.tallaNombre}</td>
                    <td style="text-align:center;">${item.cantidadStock}</td>
                    <td style="text-align:center;">S/ ${item.precioUnitarioFinal.toFixed(2)}</td>
                    <td style="text-align:center;">
                        <span class="${item.activo ? 'estado-activo' : 'estado-inactivo'}">
                            ${item.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td style="text-align:center;">
                        <button class="btn ${item.activo ? 'btn-desactivar' : 'btn-activar'}" 
                                onclick="cambiarEstado(${item.id}, ${!item.activo})">
                            ${item.activo ? 'Desactivar' : 'Activar'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function cambiarEstado(id, nuevoEstado) {
            dataAConfirmar = { id, nuevoEstado };
            document.getElementById('confirmModal').classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('confirmModal').classList.remove('active');
            dataAConfirmar = null;
        }

        async function confirmarCambio() {
            if (!dataAConfirmar) return;

            try {
                const idAConfirmar = dataAConfirmar.id;
                const response = await fetch(`/admin/tallas/api/${idAConfirmar}/toggle-estado`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activo: dataAConfirmar.nuevoEstado })
                });

                if (!response.ok) throw new Error('Error al actualizar estado');
                
                const result = await response.json();
                cerrarModal();
                
                const itemActualizado = allData.find(item => item.id === idAConfirmar);
                if (itemActualizado) {
                    itemActualizado.activo = result.activo;
                }
                mostrarTabla(allData);
                mostrarNotificacion('Estado actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar: ' + error.message, 'error');
            }
        }

        function aplicarFiltro() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const filtrados = allData.filter(item => 
                item.productoNombre.toLowerCase().includes(searchText) || 
                item.tallaNombre.toLowerCase().includes(searchText)
            );
            mostrarTabla(filtrados);
        }

        function recargar() {
            document.getElementById('searchInput').value = '';
            cargarTallas();
        }

        function mostrarNotificacion(mensaje, tipo) {
            const notif = document.createElement('div');
            notif.className = `notificacion ${tipo}`;
            notif.textContent = mensaje;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.remove();
            }, 3000);
        }
    </script>
</th:block>

</body>
</html>
