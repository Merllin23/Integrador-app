<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos</title>

    <th:block th:fragment="extraCss">
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

        <style>
            /* RESET */
            * { box-sizing: border-box; margin:0; padding:0; }
            body { font-family: 'Poppins', sans-serif; background:#f9fafb; color:#111827; }

            /* CONTENEDOR PRINCIPAL */
            .container { max-width:1200px; margin:0 auto; padding:2rem; }

            /* CABECERA */
            h1 { font-size:2.25rem; font-weight:700; margin-bottom:0.25rem; }
            p.subtitle { color:#6b7280; font-size:0.95rem; margin-bottom:1.5rem; }

            /* FILTROS */
            .filtros { display:flex; gap:0.75rem; flex-wrap:wrap; margin-bottom:1.5rem; }
            .filtros select {
                padding:0.5rem 0.75rem;
                border-radius:0.5rem;
                border:1px solid #d1d5db;
                background:white;
                outline:none;
                transition:all 0.2s;
            }
            .filtros select:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,0.15); }

            /* BOTÓN AGREGAR */
            .btn-agregar {
                background:#facc15; color:#111827; font-weight:600; padding:0.5rem 1rem;
                border-radius:0.5rem; display:inline-flex; align-items:center; transition:all 0.2s;
            }
            .btn-agregar:hover { background:#eab308; }

            /* GRID DE PRODUCTOS */
            .grid-productos { display:grid; grid-template-columns:repeat(3,1fr); gap:1.8rem; justify-content:start; }
            .card {
                background:white; border-radius:1rem; overflow:hidden;
                box-shadow:0 4px 12px rgba(0,0,0,0.08); transition:transform 0.3s, box-shadow 0.3s;
                display:flex; flex-direction:column; max-width:320px; width:100%; margin:0 auto;
            }
            .card:hover { transform:translateY(-5px); box-shadow:0 12px 25px rgba(0,0,0,0.12); }
            .card img { width:100%; height:220px; object-fit:contain; background:#f3f4f6; }
            .card-body { padding:1rem; text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between; }
            .card-body h3 { font-weight:600; font-size:1.15rem; margin-bottom:0.25rem; }
            .card-body p { color:#6b7280; font-size:0.95rem; margin-bottom:0.5rem; }

            /* ACCIONES DE CARD */
            .card-actions { display:flex; justify-content:center; gap:0.5rem; flex-wrap:wrap; margin-top:0.75rem; }
            .btn { padding:0.4rem 0.8rem; border-radius:0.5rem; font-weight:500; border:none; cursor:pointer; transition:all 0.2s; }
            .btn-ver { background:#2563eb; color:white; }
            .btn-ver:hover { background:#1d4ed8; }
            .btn-editar { background:#16a34a; color:white; }
            .btn-editar:hover { background:#15803d; }
            .btn-eliminar { background:#dc2626; color:white; }
            .btn-eliminar:hover { background:#b91c1c; }

            /* PAGINACIÓN */
            .pagination { display:flex; justify-content:center; gap:0.5rem; margin-top:2rem; flex-wrap:wrap; }
            .pagination a {
                padding:0.5rem 0.9rem; border-radius:0.5rem; border:1px solid #d1d5db;
                background:white; text-decoration:none; color:#111827; transition:all 0.2s;
            }
            .pagination a.active { background:#2563eb; color:white; border-color:#2563eb; }
            .pagination a.disabled { cursor:not-allowed; opacity:0.5; pointer-events:none; }

            /* MODALES */
            .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:50; padding:1rem; }
            .modal.active { display:flex; }
            .modal-content { background:white; border-radius:1rem; max-width:600px; width:100%; max-height:90vh; overflow-y:auto; padding:2rem; box-shadow:0 10px 25px rgba(0,0,0,0.15); position:relative; }
            .modal-content h2 { font-size:1.25rem; font-weight:600; margin-bottom:1rem; }
            .close-btn { position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.2rem; color:#6b7280; transition:all 0.2s; }
            .close-btn:hover { color:#111827; }
            .modal-content img { border-radius:0.5rem; margin-bottom:1rem; }
            .modal-content p { margin-bottom:0.5rem; }
            .modal-actions { display:flex; justify-content:center; gap:1rem; margin-top:1rem; }
            .modal-actions button { padding:0.5rem 1rem; border-radius:0.5rem; border:none; cursor:pointer; font-weight:500; transition:all 0.2s; }
            .modal-actions .btn-cancel { background:#e5e7eb; color:#111827; }
            .modal-actions .btn-cancel:hover { background:#d1d5db; }
            .modal-actions .btn-delete { background:#dc2626; color:white; }
            .modal-actions .btn-delete:hover { background:#b91c1c; }

            /* RESPONSIVE */
            @media(max-width:1024px){ .grid-productos { grid-template-columns:repeat(2,1fr); } }
            @media(max-width:640px){ .grid-productos { grid-template-columns:1fr; } }
        </style>
    </th:block>
</head>

<body>
<th:block th:fragment="mainContent">
    <div class="container">
        <h1 class="text-3xl font-semibold text-jk-blue">Gestión de Productos</h1>
        <p class="subtitle">Administra los productos disponibles en el catálogo</p>

        <!-- FILTROS Y AGREGAR -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="filtros">
                <select id="filterColegio" name="colegioId">
                    <option value="">Todos los colegios</option>
                    <option th:each="col : ${colegios}" th:value="${col.id}" th:text="${col.nombre}" th:selected="${col.id == colegioSeleccionado}"></option>
                </select>
                <select id="filterCategoria" name="categoriaId">
                    <option value="">Todas las categorías</option>
                    <option th:each="cat : ${categorias}" th:value="${cat.id}" th:text="${cat.nombre}" th:selected="${cat.id == categoriaSeleccionada}"></option>
                </select>
            </div>
            <a th:href="@{/admin/productos/nuevo}" class="btn-agregar">Agregar Producto</a>
            <a th:href="@{/admin/inventario}"
               class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium whitespace-nowrap self-end sm:self-auto">
                <i class="fas fa-eye mr-2"></i> Visualizar Stock</a>
        </div>


        <!-- GRID DE PRODUCTOS -->
        <div id="productosContainer" class="grid-productos">
            <div th:each="p : ${productos}" class="card producto-card">
                <img th:if="${p.imagenUrl}" th:src="@{${p.imagenUrl}}" alt="Producto"/>
                <div class="card-body">
                    <div>
                        <h3 th:text="${p.nombre}"></h3>
                        <p th:text="'S/ ' + ${p.precioBase}"></p>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-ver" th:data-id="${p.id}" onclick="abrirDetalle(this.dataset.id)">Ver</button>
                        <a th:href="@{'/admin/productos/' + ${p.id} + '/editar'}" class="btn btn-editar">Editar</a>
                        <button class="btn btn-eliminar" th:data-id="${p.id}" onclick="abrirEliminar(this.dataset.id)">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGINACIÓN -->
        <div class="pagination">
            <a th:classappend="${paginaActual == 1} ? ' disabled'" th:href="@{/admin/productos(page=${paginaActual - 1}, colegioId=${colegioSeleccionado}, categoriaId=${categoriaSeleccionada})}">Anterior</a>
            <span th:each="i : ${#numbers.sequence(1, totalPaginas)}">
                <a th:classappend="${i == paginaActual} ? ' active'" th:href="@{/admin/productos(page=${i}, colegioId=${colegioSeleccionado}, categoriaId=${categoriaSeleccionada})}" th:text="${i}">1</a>
            </span>
            <a th:classappend="${paginaActual == totalPaginas} ? ' disabled'" th:href="@{/admin/productos(page=${paginaActual + 1}, colegioId=${colegioSeleccionado}, categoriaId=${categoriaSeleccionada})}">Siguiente</a>
        </div>
    </div>

    <!-- MODALES -->
    <div id="modalDetalle" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal('modalDetalle')">&times;</span>
            <h2>Detalle del Producto</h2>
            <div id="detalleBody"></div>
        </div>
    </div>

    <div id="modalEliminar" class="modal">
        <div class="modal-content text-center">
            <h2>¿Eliminar producto?</h2>
            <p>Esta acción no se puede deshacer.</p>
            <div class="modal-actions">
                <button id="btnConfirmarEliminar" class="btn-delete">Eliminar</button>
                <button onclick="cerrarModal('modalEliminar')" class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="extraJs">
    <script>
        const modalDetalle = document.getElementById('modalDetalle');
        const modalEliminar = document.getElementById('modalEliminar');
        const detalleBody = document.getElementById('detalleBody');
        let productoAEliminar = null;

        async function abrirDetalle(id) {
            try {
                const res = await fetch(`/admin/productos/${id}/json`);
                if (!res.ok) throw new Error('Error al obtener producto');
                const p = await res.json();
                detalleBody.innerHTML = `
                  <img src="${p.imagenUrl || '/img/no-image.png'}" class="w-full h-64 object-contain bg-gray-100 rounded mb-4">
                  <p><strong>Nombre:</strong> ${p.nombre}</p>
                  <p><strong>Descripción:</strong> ${p.descripcion}</p>
                  <p><strong>Precio:</strong> S/ ${p.precioBase?.toFixed(2) || '0.00'}</p>
                  <p><strong>Categoría:</strong> ${p.categoria || '-'}</p>
                  <p><strong>Colección:</strong> ${p.coleccion || '-'}</p>
                  <p><strong>Colegios:</strong> ${p.colegios && p.colegios.length > 0 ? p.colegios.join(', ') : '-'}</p>
                `;
                modalDetalle.classList.add('active');
            } catch {
                alert('No se pudo cargar el detalle del producto.');
            }
        }

        function abrirEliminar(id) {
            productoAEliminar = id;
            modalEliminar.classList.add('active');
        }

        document.getElementById('btnConfirmarEliminar').addEventListener('click', () => {
            if (productoAEliminar) {
                window.location.href = `/admin/productos/${productoAEliminar}/eliminar`;
            }
        });

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // FILTROS
        const filterColegio = document.getElementById('filterColegio');
        const filterCategoria = document.getElementById('filterCategoria');

        function aplicarFiltros() {
            let url = '/admin/productos?page=1';
            if (filterColegio.value) url += '&colegioId=' + filterColegio.value;
            if (filterCategoria.value) url += '&categoriaId=' + filterCategoria.value;
            window.location.href = url;
        }

        filterColegio?.addEventListener('change', aplicarFiltros);
        filterCategoria?.addEventListener('change', aplicarFiltros);
    </script>
</th:block>
</body>
</html>
