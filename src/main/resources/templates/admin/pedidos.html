<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos</title>

    <!-- CSRF para fetch POST -->
    <meta name="_csrf" th:content="${_csrf.token ?: ''}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName ?: ''}"/>

    <!-- Fragmento CSS adicional -->
    <th:block th:fragment="extraCss">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Poppins', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
            }

            .estado-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.375rem 0.875rem;
                border-radius: 9999px;
                font-size: 0.875rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.025em;
            }

            .estado-pedido { background-color: #dbeafe; color: #1e40af; }
            .estado-en-proceso { background-color: #fef3c7; color: #92400e; }
            .estado-fabricacion { background-color: #ede9fe; color: #5b21b6; }
            .estado-preparado { background-color: #cffafe; color: #0f766e; }
            .estado-entregado { background-color: #d1fae5; color: #065f46; }

            .modal {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                justify-content: center;
                align-items: center;
                z-index: 50;
                padding: 1rem;
            }
            .modal.active { display: flex; }
            .modal-content {
                background: white;
                border-radius: 1rem;
                max-width: 700px;
                width: 100%;
                padding: 2rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                position: relative;
            }
        </style>
    </th:block>
</head>

<body>
<th:block th:fragment="mainContent">
    <div class="max-w-7xl mx-auto p-4">

        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestión de Pedidos</h1>

        <!-- FILTRO DE ESTADO -->
        <div class="mb-6 flex items-center gap-3">
            <form method="get" class="flex gap-3 w-full sm:max-w-xs">
                <select name="estado" onchange="this.form.submit()"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="" th:selected="${estadoSeleccionado == null}">Todos</option>
                    <option value="PEDIDO" th:selected="${estadoSeleccionado == 'PEDIDO'}">PEDIDO</option>
                    <option value="EN_PROCESO" th:selected="${estadoSeleccionado == 'EN_PROCESO'}">EN PROCESO</option>
                    <option value="FABRICACION" th:selected="${estadoSeleccionado == 'FABRICACION'}">FABRICACIÓN</option>
                    <option value="PREPARADO" th:selected="${estadoSeleccionado == 'PREPARADO'}">PREPARADO</option>
                    <option value="ENTREGADO" th:selected="${estadoSeleccionado == 'ENTREGADO'}">ENTREGADO</option>
                </select>
            </form>

            <!-- GUIA DE ESTADOS -->
            <div class="ml-auto text-gray-400 cursor-pointer group relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M8 10h.01M12 10h.01M16 10h.01M9 16h6M12 12v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                </svg>
                <div class="absolute left-full top-1/2 -translate-y-1/2 ml-2 w-64 p-3 bg-gray-800 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <p class="font-semibold mb-1">Guía de estados:</p>
                    <ul class="list-disc pl-4 text-xs">
                        <li>PEDIDO → Pedido registrado</li>
                        <li>EN_PROCESO → Revisión en curso</li>
                        <li>FABRICACION → Producto en fabricación</li>
                        <li>PREPARADO → Pedido listo para entrega</li>
                        <li>ENTREGADO → Pedido entregado y stock actualizado</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- TABLA DE PEDIDOS -->
        <div class="overflow-x-auto bg-white shadow-md rounded-lg">
            <table class="min-w-full text-left text-sm">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                <tr>
                    <th class="px-4 py-3">ID</th>
                    <th class="px-4 py-3">Cliente</th>
                    <th class="px-4 py-3">Fecha</th>
                    <th class="px-4 py-3">Total</th>
                    <th class="px-4 py-3">Estado</th>
                    <th class="px-4 py-3 text-center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${pedidos}" class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium" th:text="${p.id}"></td>
                    <td class="px-4 py-3" th:text="${p.usuario.nombre}"></td>
                    <td class="px-4 py-3" th:text="${#temporals.format(p.fecha, 'dd/MM/yyyy HH:mm')}"></td>
                    <td class="px-4 py-3 font-semibold" th:text="'S/ ' + ${p.total}"></td>
                    <td class="px-4 py-3">
                        <span th:class="'estado-badge estado-' + ${p.estado.toLowerCase().replace('_','-')}" th:text="${p.estado}"></span>
                    </td>
                    <td class="px-4 py-3 text-center space-x-2">
                        <button th:if="${p.estado != 'ENTREGADO'}"
                                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-xs"
                                th:attr="data-id=${p.id}"
                                onclick="abrirModalConfirmacion(this)">
                            Siguiente paso →
                        </button>

                        <button type="button"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-xs"
                                th:attr="data-id=${p.id}"
                                onclick="abrirModalDetalle(this)">
                            Ver detalle
                        </button>

                        <span th:if="${p.estado == 'ENTREGADO'}" class="text-gray-500 italic text-xs">Finalizado</span>
                    </td>
                </tr>
                <tr th:if="${pedidos.size() == 0}">
                    <td colspan="6" class="text-center py-8 text-gray-500">
                        <p class="font-medium text-lg">No hay pedidos para mostrar</p>
                        <p class="text-sm mt-1">Ajusta los filtros o verifica que existan pedidos registrados</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL GENERAL -->
    <div id="modalGeneral" class="modal">
        <div class="modal-content">
            <button onclick="cerrarModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
            <h2 id="modalTitulo" class="text-xl font-bold mb-4"></h2>
            <div id="modalContenido" class="max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-sm">Cargando...</p>
            </div>
            <div id="modalAcciones" class="mt-4 flex justify-end gap-2"></div>
        </div>
    </div>
</th:block>

<th:block th:fragment="extraJs">
    <script>
        function getCsrf() {
            const metaToken = document.querySelector('meta[name="_csrf"]');
            const metaHeader = document.querySelector('meta[name="_csrf_header"]');
            return {
                token: metaToken ? metaToken.content : '',
                header: metaHeader ? metaHeader.content : ''
            };
        }

        function abrirModalDetalle(button) {
            const id = button.getAttribute('data-id');
            const modal = document.getElementById('modalGeneral');
            const titulo = document.getElementById('modalTitulo');
            const contenido = document.getElementById('modalContenido');
            const acciones = document.getElementById('modalAcciones');

            titulo.textContent = 'Detalle del Pedido';
            contenido.innerHTML = '<p class="text-gray-500 text-sm">Cargando...</p>';
            acciones.innerHTML = '';
            modal.classList.add('active');

            fetch(`/admin/pedidos/${id}/detalle`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const dto = data.cotizacion;
                        let html = `
                            <p><strong>Cliente:</strong> ${dto.usuario.nombre} ${dto.usuario.apellido || ''}</p>
                            <p><strong>Correo:</strong> ${dto.usuario.correo || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${new Date(dto.fecha).toLocaleString()}</p>
                            <p><strong>Total:</strong> S/ ${dto.total.toFixed(2)}</p>
                            <table class="min-w-full text-left text-sm mt-2 border-t border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-1">Producto</th>
                                        <th class="px-2 py-1">Talla</th>
                                        <th class="px-2 py-1">Cantidad</th>
                                        <th class="px-2 py-1">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dto.detalles.map(d => `
                                        <tr>
                                            <td class="px-2 py-1">${d.productoTalla.producto.nombre}</td>
                                            <td class="px-2 py-1">${d.productoTalla.talla.nombreTalla}</td>
                                            <td class="px-2 py-1">${d.cantidad}</td>
                                            <td class="px-2 py-1">S/ ${(d.subtotal || (d.cantidad * d.precioUnitario)).toFixed(2)}</td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>`;
                        contenido.innerHTML = html;
                    } else {
                        contenido.innerHTML = `<p class="text-red-500 text-sm">${data.message}</p>`;
                    }
                })
                .catch(err => contenido.innerHTML = '<p class="text-red-500 text-sm">Error al cargar detalle</p>');
        }

        function abrirModalConfirmacion(button) {
            const id = button.getAttribute('data-id');
            const modal = document.getElementById('modalGeneral');
            const titulo = document.getElementById('modalTitulo');
            const contenido = document.getElementById('modalContenido');
            const acciones = document.getElementById('modalAcciones');

            titulo.textContent = 'Confirmar avance de pedido';
            contenido.innerHTML = '<p>¿Deseas avanzar este pedido al siguiente paso?</p>';
            acciones.innerHTML = '';

            const btnConfirm = document.createElement('button');
            btnConfirm.type = 'button';
            btnConfirm.className = 'px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700';
            btnConfirm.textContent = 'Sí, avanzar';
            btnConfirm.onclick = () => {
                const csrf = getCsrf();
                fetch(`/admin/pedidos/${id}/avanzar`, {
                    method: 'POST',
                    headers: csrf.token && csrf.header ? { [csrf.header]: csrf.token } : {}
                })
                .then(res => res.json())
                .then(data => {
                    cerrarModal();
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert(data.message || 'Error al avanzar el pedido');
                    }
                })
                .catch(() => alert('Error de conexión'));
            };

            const btnCancel = document.createElement('button');
            btnCancel.type = 'button';
            btnCancel.className = 'px-4 py-2 rounded bg-gray-300 hover:bg-gray-400';
            btnCancel.textContent = 'Cancelar';
            btnCancel.onclick = cerrarModal;

            acciones.appendChild(btnCancel);
            acciones.appendChild(btnConfirm);

            modal.classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('modalGeneral').classList.remove('active');
        }

        document.getElementById('modalGeneral').addEventListener('click', function(e) {
            if (e.target === this) cerrarModal();
        });
    </script>
</th:block>
</body>
</html>
