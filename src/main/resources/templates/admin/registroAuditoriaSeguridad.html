<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<!-- ====================== CSS EXTRA ====================== -->
<th:block th:fragment="extraCss">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'jk-blue': '#1e3a5f',
                'jk-red': '#dc3545',
                'jk-green': '#22c55e',
                'jk-sidebar': '#1e3a5f',
                'jk-sidebar-hover': '#2a4d6b'
              }
            }
          }
        }
    </script>
</th:block>

<!-- ====================== CONTENIDO PRINCIPAL ====================== -->
<th:block th:fragment="mainContent">

    <!-- Título -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-semibold text-jk-blue">Auditoría de Seguridad</h1>
                <p class="text-gray-600 mt-2">Registros del sistema y acciones realizadas por los usuarios</p>
            </div>
        </div>
    </div>

    <!-- Contenido -->
    <div class="bg-white rounded-lg shadow-sm p-6">

        <!-- Buscador -->
        <div class="flex justify-between mb-6">
            <input id="buscador" type="text" placeholder="Buscar por usuario, acción o IP..."
                   class="w-80 px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring focus:ring-jk-blue"
                   onkeyup="buscarTexto()">
        </div>

        <!-- Tabla -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                        onclick="ordenarPor('fecha')">
                        Fecha <i class="fas fa-sort ml-1"></i>
                    </th>

                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                        onclick="ordenarPor('usuario')">
                        Usuario <i class="fas fa-sort ml-1"></i>
                    </th>

                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Acción
                    </th>

                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                        onclick="ordenarPor('ip')">
                        IP <i class="fas fa-sort ml-1"></i>
                    </th>
                </tr>
                </thead>

                <tbody id="tabla-auditoria" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="4" class="text-center py-10 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl"></i>
                        <p class="mt-2">Cargando registros...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <div id="paginacion" class="flex justify-between items-center mt-6 hidden">
            <span class="text-sm text-gray-600">
                Página <span id="pagina-actual"></span> de <span id="total-paginas"></span>
            </span>

            <div class="flex gap-2">
                <button id="btn-prev"
                        class="px-4 py-2 border rounded-lg hover:bg-gray-100 disabled:opacity-50"
                        onclick="paginaAnterior()">
                    <i class="fas fa-chevron-left"></i>
                </button>

                <button id="btn-next"
                        class="px-4 py-2 border rounded-lg hover:bg-gray-100 disabled:opacity-50"
                        onclick="paginaSiguiente()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

    </div>

</th:block>

<th:block th:fragment="extraJs">
    <script>
        let pagina = 0;
        let totalPaginas = 1;

        document.addEventListener("DOMContentLoaded", () => {
            cargarAuditoria();
        });

        async function cargarAuditoria() {
            const url = `/admin/api/auditoria?page=${pagina}&size=20`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (!data.success) {
                    mostrarError("No se pudieron cargar los registros.");
                    return;
                }

                llenarTabla(data.registros);
                actualizarPaginacion(data);

            } catch (error) {
                console.error(error);
                mostrarError("Error al conectar con el servidor.");
            }
        }

        function llenarTabla(registros) {
            const tabla = document.getElementById("tabla-auditoria");

            if (!registros || registros.length === 0) {
                tabla.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-10 text-gray-500">
                            <i class="fas fa-folder-open text-4xl"></i>
                            <p class="mt-2">No hay registros</p>
                        </td>
                    </tr>`;
                return;
            }

            tabla.innerHTML = registros.map(r => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${new Date(r.fecha).toLocaleString("es-PE")}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${r.usuario || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${r.accion}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${r.ip || "-"}
                    </td>
                </tr>
            `).join("");
        }

        function actualizarPaginacion(data) {
            pagina = data.paginaActual;
            totalPaginas = data.totalPaginas;

            document.getElementById("pagina-actual").textContent = pagina + 1;
            document.getElementById("total-paginas").textContent = totalPaginas;

            document.getElementById("paginacion").classList.remove("hidden");

            document.getElementById("btn-prev").disabled = pagina === 0;
            document.getElementById("btn-next").disabled = pagina >= totalPaginas - 1;
        }

        function paginaAnterior() {
            if (pagina > 0) {
                pagina--;
                cargarAuditoria();
            }
        }

        function paginaSiguiente() {
            if (pagina < totalPaginas - 1) {
                pagina++;
                cargarAuditoria();
            }
        }

        function mostrarError(msg) {
            const tabla = document.getElementById("tabla-auditoria");
            tabla.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-6 text-red-500">
                        ${msg}
                    </td>
                </tr>`;
        }
    </script>
</th:block>

</html>
